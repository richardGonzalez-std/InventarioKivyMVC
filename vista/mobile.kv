#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import ProductoItem vista.screens.inventory_screen.ProductoItem

# ═══════════════════════════════════════════════════════════════════════════════
# COLORES DECORACIONES
# ═══════════════════════════════════════════════════════════════════════════════
#:set CORPOELEC_BLUE [0, 0.102, 0.439, 1]
#:set CORPOELEC_RED [0.89, 0.11, 0.137, 1]
#:set CORPOELEC_BLUE_HEX "#001A70"
#:set CORPOELEC_RED_HEX "#E31C23"


# ═══════════════════════════════════════════════════════════════════════════════
# COMPONENTE: BaseMDNavigationItem
# ═══════════════════════════════════════════════════════════════════════════════
<BaseMDNavigationItem>:
    icon: "camera-document"
    text: "Scanner"

    MDNavigationItemIcon:
        icon: root.icon

    MDNavigationItemLabel:
        text: root.text


# ═══════════════════════════════════════════════════════════════════════════════
# PANTALLA: LoginScreen
# ═══════════════════════════════════════════════════════════════════════════════
<LoginScreen>:
    name: "login"

    MDBoxLayout:
        orientation: "vertical"
        md_bg_color: self.theme_cls.backgroundColor

        # Espaciador superior
        MDWidget:
            size_hint_y: 0.1

        # Logo y branding
        MDBoxLayout:
            orientation: "vertical"
            size_hint_y: None
            height: "180dp"
            padding: "20dp"
            spacing: "10dp"

            MDIcon:
                icon: "lightning-bolt"
                font_size: "80sp"
                pos_hint: {"center_x": 0.5}
                theme_text_color: "Custom"
                text_color: CORPOELEC_RED

            MDLabel:
                text: "SIAM"
                halign: "center"
                font_style: "Display"
                role: "small"
                theme_text_color: "Custom"
                text_color: CORPOELEC_BLUE
                bold: True

            MDLabel:
                text: "Sistema de Inventario Automático"
                halign: "center"
                font_style: "Title"
                role: "medium"
                theme_text_color: "Secondary"

        # Formulario de login
        MDBoxLayout:
            orientation: "vertical"
            padding: ["30dp", "20dp", "30dp", "20dp"]
            spacing: "15dp"
            size_hint_y: None
            height: "280dp"

            MDLabel:
                text: "Iniciar Sesión"
                halign: "center"
                font_style: "Headline"
                role: "small"
                size_hint_y: None
                height: "40dp"

            # Campo de usuario
            MDTextField:
                id: username_field
                mode: "outlined"
                size_hint_x: 1

                MDTextFieldLeadingIcon:
                    icon: "account"

                MDTextFieldHintText:
                    text: "Usuario"

            # Campo de contraseña
            MDTextField:
                id: password_field
                mode: "outlined"
                size_hint_x: 1
                password: True

                MDTextFieldLeadingIcon:
                    icon: "lock"

                MDTextFieldHintText:
                    text: "Contraseña"

            # Botón de login
            MDButton:
                style: "filled"
                size_hint_x: 1
                pos_hint: {"center_x": 0.5}
                md_bg_color: CORPOELEC_BLUE
                on_release: root.attempt_login()

                MDButtonText:
                    text: "INGRESAR"
                    bold: True

        # Espaciador inferior
        MDWidget:

        # Footer
        MDBoxLayout:
            orientation: "vertical"
            size_hint_y: None
            height: "60dp"
            padding: "10dp"

            MDLabel:
                text: "DECORACIONES 100% VENEZOLANO C.A"
                halign: "center"
                font_style: "Label"
                role: "small"
                theme_text_color: "Hint"


# ═══════════════════════════════════════════════════════════════════════════════
# PANTALLA: MainScreen (Contenedor principal post-login)
# ═══════════════════════════════════════════════════════════════════════════════
<MainScreen>:
    name: "main"

    MDBoxLayout:
        orientation: "vertical"
        md_bg_color: self.theme_cls.backgroundColor

        MDScreenManager:
            id: screen_manager

            CameraScreen:
                name: "camera"

            InventoryScreen:
                name: "consumos"

            # TODO: Implementar estas pantallas
            # InventoryScreen:
            #     name: "mantenimiento"
            #
            # InventoryScreen:
            #     name: "oficina"

        MDNavigationBar:
            on_switch_tabs: app.on_switch_tabs(*args)

            BaseMDNavigationItem:
                name: "camera"
                text: "Escanear"
                icon: "barcode-scan"
                active: True

            BaseMDNavigationItem:
                name: "consumos"
                text: "Inventario"
                icon: "package-variant"

            # TODO: Implementar estas pestañas
            # BaseMDNavigationItem:
            #     name: "mantenimiento"
            #     text: "Salidas"
            #     icon: "package-up"
            #
            # BaseMDNavigationItem:
            #     name: "oficina"
            #     text: "Stock"
            #     icon: "warehouse"


# ═══════════════════════════════════════════════════════════════════════════════
# PANTALLA: CameraScreen
# ═══════════════════════════════════════════════════════════════════════════════
<CameraScreen>:
    MDBoxLayout:
        orientation: "vertical"

        MDTopAppBar:
            type: "small"
            MDTopAppBarLeadingButtonContainer:
                MDActionTopAppBarButton:
                    icon: "account-circle"
                    on_release: root._mostrar_menu_usuario()

            MDTopAppBarTitle:
                text: "Escanear Código"
                halign: "center"

            MDTopAppBarTrailingButtonContainer:
                MDActionTopAppBarButton:
                    icon: "logout"
                    on_release: app.logout()

        # Contenedor de cámara
        MDBoxLayout:
            id: camera_container

        # Controles
        MDBoxLayout:
            id: controls_container
            orientation: "horizontal"
            size_hint_y: None
            height: "60dp"
            padding: "10dp"
            spacing: "10dp"

        # Status
        MDLabel:
            id: status_label
            text: "Apunte la cámara al código de barras"
            halign: "center"
            size_hint_y: None
            height: "40dp"
            theme_text_color: "Secondary"


# ═══════════════════════════════════════════════════════════════════════════════
# PANTALLA: InventoryScreen (Lista de productos)
# ═══════════════════════════════════════════════════════════════════════════════
<InventoryScreen>:
    MDBoxLayout:
        orientation: "vertical"

        # Barra superior minimalista
        MDTopAppBar:
            id: inventory_toolbar
            type: "small"

            MDTopAppBarLeadingButtonContainer:
                MDBoxLayout:
                    size_hint_x: None
                    width: "80dp" if root.is_offline else "0dp"
                    opacity: 1 if root.is_offline else 0
                    padding: ["8dp", "0dp"]

                    MDIcon:
                        icon: "cloud-off-outline"
                        theme_text_color: "Custom"
                        text_color: [0.9, 0.6, 0.1, 1]
                        pos_hint: {"center_y": 0.5}

                    MDLabel:
                        text: "Offline"
                        font_style: "Label"
                        role: "small"
                        theme_text_color: "Custom"
                        text_color: [0.9, 0.6, 0.1, 1]
                        pos_hint: {"center_y": 0.5}

            MDTopAppBarTitle:
                text: "Inventario"
                halign: "center"

            MDTopAppBarTrailingButtonContainer:
                MDActionTopAppBarButton:
                    icon: "file-chart-outline"
                    on_release: root.generar_reporte()

                MDActionTopAppBarButton:
                    icon: "refresh"
                    on_release: root.refrescar()

        # Contenedor principal
        MDBoxLayout:
            orientation: "vertical"

            # Spinner de carga
            MDBoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: "100dp" if root.is_loading else "0dp"
                opacity: 1 if root.is_loading else 0
                padding: "20dp"

                MDCircularProgressIndicator:
                    size_hint: None, None
                    size: "48dp", "48dp"
                    pos_hint: {"center_x": 0.5}

                MDLabel:
                    text: "Cargando productos..."
                    halign: "center"
                    theme_text_color: "Secondary"

            # Mensaje de error
            MDBoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: "100dp" if root.error_message else "0dp"
                opacity: 1 if root.error_message else 0
                padding: "20dp"

                MDIcon:
                    icon: "alert-circle-outline"
                    font_size: "48sp"
                    pos_hint: {"center_x": 0.5}
                    theme_text_color: "Custom"
                    text_color: CORPOELEC_RED

                MDLabel:
                    text: root.error_message
                    halign: "center"
                    theme_text_color: "Error"

            # Estado vacío
            MDBoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: "150dp" if (not root.is_loading and not root.error_message and len(root.productos) == 0) else "0dp"
                opacity: 1 if (not root.is_loading and not root.error_message and len(root.productos) == 0) else 0
                padding: "20dp"

                MDIcon:
                    icon: "cloud-off-outline" if root.is_offline else "package-variant"
                    font_size: "64sp"
                    pos_hint: {"center_x": 0.5}
                    theme_text_color: "Custom"
                    text_color: [0.9, 0.6, 0.1, 1] if root.is_offline else [0.7, 0.7, 0.7, 1]

                MDLabel:
                    text: "Sin conexión" if root.is_offline else "Sin productos"
                    halign: "center"
                    font_style: "Title"
                    role: "medium"
                    theme_text_color: "Secondary"

                MDLabel:
                    text: "Conecta a internet para sincronizar" if root.is_offline else "Importa productos con el script"
                    halign: "center"
                    theme_text_color: "Hint"

            # Lista de productos (RecycleView para rendimiento)
            RecycleView:
                id: product_rv
                viewclass: 'ProductoItem'

                RecycleBoxLayout:
                    orientation: 'vertical'
                    default_size: None, dp(92)
                    default_size_hint: 1, None
                    size_hint_y: None
                    height: self.minimum_height
                    spacing: dp(4)
                    padding: dp(8)

        # FAB para agregar
        MDAnchorLayout:
            anchor_x: "right"
            anchor_y: "bottom"
            padding: "16dp"
            size_hint_y: None
            height: "80dp"

            MDFabButton:
                icon: "plus"
                style: "standard"
                md_bg_color: CORPOELEC_RED


# ═══════════════════════════════════════════════════════════════════════════════
# WIDGET RAÍZ
# ═══════════════════════════════════════════════════════════════════════════════
MDScreenManager:
    id: root_manager

    LoginScreen:
        name: "login"

    MainScreen:
        name: "main"
